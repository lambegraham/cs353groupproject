'use strict';
// https://github.com/tc39/proposal-observable
var $ = require('../internals/export');
var DESCRIPTORS = require('../internals/descriptors');
var setSpecies = require('../internals/set-species');
var aFunction = require('../internals/a-function');
var anObject = require('../internals/an-object');
var isObject = require('../internals/is-object');
var anInstance = require('../internals/an-instance');
var defineProperty = require('../internals/object-define-property').f;
var hide = require('../internals/hide');
var redefineAll = require('../internals/redefine-all');
var getIterator = require('../internals/get-iterator');
var iterate = require('../internals/iterate');
var hostReportErrors = require('../internals/host-report-errors');
var wellKnownSymbol = require('../internals/well-known-symbol');
var InternalStateModule = require('../internals/internal-state');

var OBSERVABLE = wellKnownSymbol('observable');
var getInternalState = InternalStateModule.get;
var setInternalState = InternalStateModule.set;

var getMethod = function (fn) {
  return fn == null ? undefined : aFunction(fn);
***REMOVED***;

var cleanupSubscription = function (subscriptionState) {
  var cleanup = subscriptionState.cleanup;
  if (cleanup) {
    subscriptionState.cleanup = undefined;
    try {
      cleanup();
  ***REMOVED*** catch (error) {
      hostReportErrors(error);
  ***REMOVED***
***REMOVED***
***REMOVED***;

var subscriptionClosed = function (subscriptionState) {
  return subscriptionState.observer === undefined;
***REMOVED***;

var close = function (subscription, subscriptionState) {
  if (!DESCRIPTORS) {
    subscription.closed = true;
    var subscriptionObserver = subscriptionState.subscriptionObserver;
    if (subscriptionObserver) subscriptionObserver.closed = true;
***REMOVED*** subscriptionState.observer = undefined;
***REMOVED***;

var Subscription = function (observer, subscriber) {
  var subscriptionState = setInternalState(this, {
    cleanup: undefined,
    observer: anObject(observer),
    subscriptionObserver: undefined
***REMOVED***);
  var start;
  if (!DESCRIPTORS) this.closed = false;
  try {
    if (start = getMethod(observer.start)) start.call(observer, this);
***REMOVED*** catch (error) {
    hostReportErrors(error);
***REMOVED***
  if (subscriptionClosed(subscriptionState)) return;
  var subscriptionObserver = subscriptionState.subscriptionObserver = new SubscriptionObserver(this);
  try {
    var cleanup = subscriber(subscriptionObserver);
    var subscription = cleanup;
    if (cleanup != null) subscriptionState.cleanup = typeof cleanup.unsubscribe === 'function'
      ? function () { subscription.unsubscribe(); ***REMOVED***
      : aFunction(cleanup);
***REMOVED*** catch (error) {
    subscriptionObserver.error(error);
    return;
***REMOVED*** if (subscriptionClosed(subscriptionState)) cleanupSubscription(subscriptionState);
***REMOVED***;

Subscription.prototype = redefineAll({***REMOVED***, {
  unsubscribe: function unsubscribe() {
    var subscriptionState = getInternalState(this);
    if (!subscriptionClosed(subscriptionState)) {
      close(this, subscriptionState);
      cleanupSubscription(subscriptionState);
  ***REMOVED***
***REMOVED***
***REMOVED***);

if (DESCRIPTORS) defineProperty(Subscription.prototype, 'closed', {
  configurable: true,
  get: function () {
    return subscriptionClosed(getInternalState(this));
***REMOVED***
***REMOVED***);

var SubscriptionObserver = function (subscription) {
  setInternalState(this, { subscription: subscription ***REMOVED***);
  if (!DESCRIPTORS) this.closed = false;
***REMOVED***;

SubscriptionObserver.prototype = redefineAll({***REMOVED***, {
  next: function next(value) {
    var subscriptionState = getInternalState(getInternalState(this).subscription);
    if (!subscriptionClosed(subscriptionState)) {
      var observer = subscriptionState.observer;
      try {
        var nextMethod = getMethod(observer.next);
        if (nextMethod) nextMethod.call(observer, value);
    ***REMOVED*** catch (error) {
        hostReportErrors(error);
    ***REMOVED***
  ***REMOVED***
***REMOVED***,
  error: function error(value) {
    var subscription = getInternalState(this).subscription;
    var subscriptionState = getInternalState(subscription);
    if (!subscriptionClosed(subscriptionState)) {
      var observer = subscriptionState.observer;
      close(subscription, subscriptionState);
      try {
        var errorMethod = getMethod(observer.error);
        if (errorMethod) errorMethod.call(observer, value);
        else hostReportErrors(value);
    ***REMOVED*** catch (err) {
        hostReportErrors(err);
    ***REMOVED*** cleanupSubscription(subscriptionState);
  ***REMOVED***
***REMOVED***,
  complete: function complete() {
    var subscription = getInternalState(this).subscription;
    var subscriptionState = getInternalState(subscription);
    if (!subscriptionClosed(subscriptionState)) {
      var observer = subscriptionState.observer;
      close(subscription, subscriptionState);
      try {
        var completeMethod = getMethod(observer.complete);
        if (completeMethod) completeMethod.call(observer);
    ***REMOVED*** catch (error) {
        hostReportErrors(error);
    ***REMOVED*** cleanupSubscription(subscriptionState);
  ***REMOVED***
***REMOVED***
***REMOVED***);

if (DESCRIPTORS) defineProperty(SubscriptionObserver.prototype, 'closed', {
  configurable: true,
  get: function () {
    return subscriptionClosed(getInternalState(getInternalState(this).subscription));
***REMOVED***
***REMOVED***);

var $Observable = function Observable(subscriber) {
  anInstance(this, $Observable, 'Observable');
  setInternalState(this, { subscriber: aFunction(subscriber) ***REMOVED***);
***REMOVED***;

redefineAll($Observable.prototype, {
  subscribe: function subscribe(observer) {
    var length = arguments.length;
    return new Subscription(typeof observer === 'function' ? {
      next: observer,
      error: length > 1 ? arguments[1] : undefined,
      complete: length > 2 ? arguments[2] : undefined
  ***REMOVED*** : isObject(observer) ? observer : {***REMOVED***, getInternalState(this).subscriber);
***REMOVED***
***REMOVED***);

redefineAll($Observable, {
  from: function from(x) {
    var C = typeof this === 'function' ? this : $Observable;
    var observableMethod = getMethod(anObject(x)[OBSERVABLE]);
    if (observableMethod) {
      var observable = anObject(observableMethod.call(x));
      return observable.constructor === C ? observable : new C(function (observer) {
        return observable.subscribe(observer);
    ***REMOVED***);
  ***REMOVED***
    var iterator = getIterator(x);
    return new C(function (observer) {
      iterate(iterator, function (it) {
        observer.next(it);
        if (observer.closed) return iterate.stop();
    ***REMOVED***, undefined, false, true);
      observer.complete();
  ***REMOVED***);
***REMOVED***,
  of: function of() {
    var C = typeof this === 'function' ? this : $Observable;
    var length = arguments.length;
    var items = new Array(length);
    var index = 0;
    while (index < length) items[index] = arguments[index++];
    return new C(function (observer) {
      for (var i = 0; i < length; i++) {
        observer.next(items[i]);
        if (observer.closed) return;
    ***REMOVED*** observer.complete();
  ***REMOVED***);
***REMOVED***
***REMOVED***);

hide($Observable.prototype, OBSERVABLE, function () { return this; ***REMOVED***);

$({ global: true ***REMOVED***, {
  Observable: $Observable
***REMOVED***);

setSpecies('Observable');
