var global = require('../internals/global');
var getOwnPropertyDescriptor = require('../internals/object-get-own-property-descriptor').f;
var classof = require('../internals/classof-raw');
var macrotask = require('../internals/task').set;
var userAgent = require('../internals/user-agent');

var MutationObserver = global.MutationObserver || global.WebKitMutationObserver;
var process = global.process;
var Promise = global.Promise;
var IS_NODE = classof(process) == 'process';
// Node.js 11 shows ExperimentalWarning on getting `queueMicrotask`
var queueMicrotaskDescriptor = getOwnPropertyDescriptor(global, 'queueMicrotask');
var queueMicrotask = queueMicrotaskDescriptor && queueMicrotaskDescriptor.value;

var flush, head, last, notify, toggle, node, promise, then;

// modern engines have queueMicrotask method
if (!queueMicrotask) {
  flush = function () {
    var parent, fn;
    if (IS_NODE && (parent = process.domain)) parent.exit();
    while (head) {
      fn = head.fn;
      head = head.next;
      try {
        fn();
    ***REMOVED*** catch (error) {
        if (head) notify();
        else last = undefined;
        throw error;
    ***REMOVED***
  ***REMOVED*** last = undefined;
    if (parent) parent.enter();
***REMOVED***

  // Node.js
  if (IS_NODE) {
    notify = function () {
      process.nextTick(flush);
  ***REMOVED***
  // browsers with MutationObserver, except iOS - https://github.com/zloirock/core-js/issues/339
***REMOVED*** else if (MutationObserver && !/(iphone|ipod|ipad).*applewebkit/i.test(userAgent)) {
    toggle = true;
    node = document.createTextNode('');
    new MutationObserver(flush).observe(node, { characterData: true ***REMOVED***); // eslint-disable-line no-new
    notify = function () {
      node.data = toggle = !toggle;
  ***REMOVED***
  // environments with maybe non-completely correct, but existent Promise
***REMOVED*** else if (Promise && Promise.resolve) {
    // Promise.resolve without an argument throws an error in LG WebOS 2
    promise = Promise.resolve(undefined);
    then = promise.then;
    notify = function () {
      then.call(promise, flush);
  ***REMOVED***
  // for other environments - macrotask based on:
  // - setImmediate
  // - MessageChannel
  // - window.postMessag
  // - onreadystatechange
  // - setTimeout
***REMOVED*** else {
    notify = function () {
      // strange IE + webpack dev server bug - use .call(global)
      macrotask.call(global, flush);
  ***REMOVED***
***REMOVED***
***REMOVED***

module.exports = queueMicrotask || function (fn) {
  var task = { fn: fn, next: undefined ***REMOVED***;
  if (last) last.next = task;
  if (!head) {
    head = task;
    notify();
***REMOVED*** last = task;
***REMOVED***;
