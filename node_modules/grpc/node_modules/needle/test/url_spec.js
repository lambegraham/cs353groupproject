var needle  = require('../'),
    sinon   = require('sinon'),
    should  = require('should'),
    http    = require('http'),
    helpers = require('./helpers');

var port = 3456;

describe('urls', function() {

  var server, url;

  function send_request(cb) {
    return needle.get(url, cb);
***REMOVED***

  before(function(done){
    server = helpers.server({ port: port ***REMOVED***, done);
***REMOVED***)

  after(function(done) {
    server.close(done);
***REMOVED***)

  describe('null URL', function(){

    it('throws', function(){
      (function() {
      send_request()
    ***REMOVED***).should.throw();
  ***REMOVED***)

***REMOVED***)

  describe('invalid protocol', function(){

    before(function() {
      url = 'foo://google.com/what'
  ***REMOVED***)

    it('does not throw', function(done) {
      (function() {
        send_request(function(err) { 
          done();
      ***REMOVED***)
    ***REMOVED***).should.not.throw()
  ***REMOVED***)

    it('returns an error', function(done) {
      send_request(function(err) {
        err.should.be.an.Error;
        err.code.should.match(/ENOTFOUND|EADDRINFO|EAI_AGAIN/)
        done();
    ***REMOVED***)
  ***REMOVED***)

***REMOVED***)

  describe('invalid host', function(){

    before(function() {
      url = 'http://s1\\\2.com/'
  ***REMOVED***)

    it('fails', function(done) {
      (function() {
        send_request(function(){ ***REMOVED***)
    ***REMOVED***.should.throw(TypeError))
      done()
  ***REMOVED***)

***REMOVED***)

/*
  describe('invalid path', function(){

    before(function() {
      url = 'http://www.google.com\\\/x\\\   %^&*() /x2.com/'
  ***REMOVED***)

    it('fails', function(done) {
      send_request(function(err) {
        err.should.be.an.Error;
        done();
    ***REMOVED***)
  ***REMOVED***)

***REMOVED***)
*/

  describe('valid protocol and path', function() {

    before(function() {
      url = 'http://localhost:' + port + '/foo';
  ***REMOVED***)

    it('works', function(done) {
      send_request(function(err){
        should.not.exist(err);
        done();
    ***REMOVED***)
  ***REMOVED***)

***REMOVED***)

  describe('no protocol but with slashes and valid path', function() {

    before(function() {
      url = '//localhost:' + port + '/foo';
  ***REMOVED***)

    it('works', function(done) {
      send_request(function(err){
        should.not.exist(err);
        done();
    ***REMOVED***)
  ***REMOVED***)

***REMOVED***)

  describe('no protocol nor slashes and valid path', function() {

    before(function() {
      url = 'localhost:' + port + '/foo';
  ***REMOVED***)

    it('works', function(done) {
      send_request(function(err){
        should.not.exist(err);
        done();
    ***REMOVED***)
  ***REMOVED***)

***REMOVED***)

  describe('double encoding', function() {

    var path = '/foo?email=' + encodeURIComponent('what-ever@Example.Com');

    before(function() {
      url = 'localhost:' + port + path
  ***REMOVED***);

    it('should not occur', function(done) {
      send_request(function(err, res) {
        should.not.exist(err);
        should(res.req.path).be.exactly(path);
        done();
    ***REMOVED***);

  ***REMOVED***);

***REMOVED***)

***REMOVED***)
