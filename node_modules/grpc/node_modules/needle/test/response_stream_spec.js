var should = require('should'),
    needle = require('./../'),
    http   = require('http'),
    stream = require('stream'),
    fs     = require('fs'),
    port   = 11111,
    server;

describe('response streams', function() {

  describe('when the server sends back json', function(){

    before(function() {
      server = http.createServer(function(req, res) {
        res.setHeader('Content-Type', 'application/json')
        res.end('{"foo":"bar"***REMOVED***')
    ***REMOVED***).listen(port);
  ***REMOVED***);

    after(function() {
      server.close();
  ***REMOVED***)

    describe('and the client uses streams', function(){

      it('should create a proper streams2 stream', function(done) {
        var stream = needle.get('localhost:' + port)

        // newer node versions set this to null instead of false
        var bool = !!stream._readableState.flowing;
        should.equal(false, bool);

        var readableCalled = false;
        stream.on('readable', function() {
          readableCalled = true;
      ***REMOVED***)

        stream.on('done', function() {
          readableCalled.should.be.true;
          done();
      ***REMOVED***);

        stream.resume()

    ***REMOVED***)

      it('emits a single data item which is our JSON object', function(done) {
        var stream = needle.get('localhost:' + port)

        var chunks = [];
        stream.on('readable', function () {
          while (chunk = this.read()) {
            chunk.should.be.an.Object;
            chunks.push(chunk);
        ***REMOVED***
      ***REMOVED***)

        stream.on('done', function () {
          chunks.should.have.length(1)
          chunks[0].should.have.property('foo', 'bar');
          done();
      ***REMOVED***);
    ***REMOVED***)

      it('emits a raw buffer if we do not want to parse JSON', function(done) {
        var stream  = needle.get('localhost:' + port, { parse: false ***REMOVED***)

        var chunks = [];
        stream.on('readable', function () {
          while (chunk = this.read()) {
            Buffer.isBuffer(chunk).should.be.true;
            chunks.push(chunk);
        ***REMOVED***
      ***REMOVED***)

        stream.on('done', function() {
          var body = Buffer.concat(chunks).toString();
          body.should.equal('{"foo":"bar"***REMOVED***')
          done();
      ***REMOVED***);
    ***REMOVED***)

  ***REMOVED***)
***REMOVED***)

  describe('when the server sends back what was posted to it', function () {
    var file = 'asdf.txt';

    before(function(done){
      server = http.createServer(function(req, res) {
        res.setHeader('Content-Type', 'application/octet')
        req.pipe(res);
    ***REMOVED***).listen(port);

      fs.writeFile(file, 'contents of stream', done);
  ***REMOVED***);

    after(function(done){
      server.close();
      fs.unlink(file, done);
  ***REMOVED***)

    it('can PUT a stream', function (done) {
      var stream = needle.put('localhost:' + port, fs.createReadStream(file), { stream: true ***REMOVED***);

      var chunks = [];
      stream.on('readable', function () {
        while (chunk = this.read()) {
          Buffer.isBuffer(chunk).should.be.true;
          chunks.push(chunk);
      ***REMOVED***
    ***REMOVED***)

      stream.on('end', function () {
        var body = Buffer.concat(chunks).toString();
          body.should.equal('contents of stream')
          done();
    ***REMOVED***);
  ***REMOVED***);

    it('can PATCH a stream', function (done) {
      var stream = needle.patch('localhost:' + port, fs.createReadStream(file), { stream: true ***REMOVED***);

      var chunks = [];
      stream.on('readable', function () {
        while (chunk = this.read()) {
          Buffer.isBuffer(chunk).should.be.true;
          chunks.push(chunk);
      ***REMOVED***
    ***REMOVED***)

      stream.on('end', function () {
        var body = Buffer.concat(chunks).toString();
          body.should.equal('contents of stream')
          done();
    ***REMOVED***);
  ***REMOVED***);
***REMOVED***)
***REMOVED***)
