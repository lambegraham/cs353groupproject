var should = require('should'),
    needle = require('./../'),
    http   = require('http'),
    zlib   = require('zlib'),
    stream = require('stream'),
    port   = 11123,
    server;

describe('compression', function(){

  require.bind(null, 'zlib').should.not.throw()

  var jsonData = '{"foo":"bar"***REMOVED***';

  describe('when server supports compression', function(){

    before(function(){
      server = http.createServer(function(req, res) {
        var raw = new stream.PassThrough();

        var acceptEncoding = req.headers['accept-encoding'];
        if (!acceptEncoding) {
          acceptEncoding = '';
      ***REMOVED***

        if (acceptEncoding.match(/\bdeflate\b/)) {
          res.setHeader('Content-Encoding', 'deflate');
          raw.pipe(zlib.createDeflate()).pipe(res);
      ***REMOVED*** else if (acceptEncoding.match(/\bgzip\b/)) {
          res.setHeader('Content-Encoding', 'gzip');
          raw.pipe(zlib.createGzip()).pipe(res);
      ***REMOVED*** else {
          raw.pipe(res);
      ***REMOVED***

        res.setHeader('Content-Type', 'application/json')
        if (req.headers['with-bad']) {
          res.end('foo'); // end, no deflate data
      ***REMOVED*** else {
          raw.end(jsonData)
      ***REMOVED***

    ***REMOVED***)

      server.listen(port);
  ***REMOVED***);

    after(function(done){
      server.close(done);
  ***REMOVED***)

    describe('and client requests no compression', function() {
      it('should have the body decompressed', function(done){
        needle.get('localhost:' + port, function(err, response, body){
          should.ifError(err);
          body.should.have.property('foo', 'bar');
          response.bytes.should.equal(jsonData.length);
          done();
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)

    describe('and client requests gzip compression', function() {
      it('should have the body decompressed', function(done){
        needle.get('localhost:' + port, {headers: {'Accept-Encoding': 'gzip'***REMOVED******REMOVED***, function(err, response, body){
          should.ifError(err);
          body.should.have.property('foo', 'bar');
          response.bytes.should.not.equal(jsonData.length);
          done();
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)

    describe('and client requests deflate compression', function() {
      it('should have the body decompressed', function(done){
        needle.get('localhost:' + port, {headers: {'Accept-Encoding': 'deflate'***REMOVED******REMOVED***, function(err, response, body){
          should.ifError(err);
          body.should.have.property('foo', 'bar');
          response.bytes.should.not.equal(jsonData.length);
          done();
      ***REMOVED***)
    ***REMOVED***)

      it('should rethrow errors from decompressors', function(done){
        needle.get('localhost:' + port, {headers: {'Accept-Encoding': 'deflate', 'With-Bad': 'true'***REMOVED******REMOVED***, function(err, response, body) {
          should.exist(err);
          err.message.should.equal("incorrect header check");
          err.code.should.equal("Z_DATA_ERROR")
          done();
      ***REMOVED***)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)
***REMOVED***)
