module.exports = realpath
realpath.realpath = realpath
realpath.sync = realpathSync
realpath.realpathSync = realpathSync
realpath.monkeypatch = monkeypatch
realpath.unmonkeypatch = unmonkeypatch

var fs = require('fs')
var origRealpath = fs.realpath
var origRealpathSync = fs.realpathSync

var version = process.version
var ok = /^v[0-5]\./.test(version)
var old = require('./old.js')

function newError (er) {
  return er && er.syscall === 'realpath' && (
    er.code === 'ELOOP' ||
    er.code === 'ENOMEM' ||
    er.code === 'ENAMETOOLONG'
  )
***REMOVED***

function realpath (p, cache, cb) {
  if (ok) {
    return origRealpath(p, cache, cb)
***REMOVED***

  if (typeof cache === 'function') {
    cb = cache
    cache = null
***REMOVED***
  origRealpath(p, cache, function (er, result) {
    if (newError(er)) {
      old.realpath(p, cache, cb)
  ***REMOVED*** else {
      cb(er, result)
  ***REMOVED***
***REMOVED***)
***REMOVED***

function realpathSync (p, cache) {
  if (ok) {
    return origRealpathSync(p, cache)
***REMOVED***

  try {
    return origRealpathSync(p, cache)
***REMOVED*** catch (er) {
    if (newError(er)) {
      return old.realpathSync(p, cache)
  ***REMOVED*** else {
      throw er
  ***REMOVED***
***REMOVED***
***REMOVED***

function monkeypatch () {
  fs.realpath = realpath
  fs.realpathSync = realpathSync
***REMOVED***

function unmonkeypatch () {
  fs.realpath = origRealpath
  fs.realpathSync = origRealpathSync
***REMOVED***
