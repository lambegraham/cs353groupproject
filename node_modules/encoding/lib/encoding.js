'use strict';

var iconvLite = require('iconv-lite');
// Load Iconv from an external file to be able to disable Iconv for webpack
// Add /\/iconv-loader$/ to webpack.IgnorePlugin to ignore it
var Iconv = require('./iconv-loader');

// Expose to the world
module.exports.convert = convert;

/**
 * Convert encoding of an UTF-8 string or a buffer
 *
 * @param {String|Buffer***REMOVED*** str String to be converted
 * @param {String***REMOVED*** to Encoding to be converted to
 * @param {String***REMOVED*** [from='UTF-8'] Encoding to be converted from
 * @param {Boolean***REMOVED*** useLite If set to ture, force to use iconvLite
 * @return {Buffer***REMOVED*** Encoded string
 */
function convert(str, to, from, useLite) {
    from = checkEncoding(from || 'UTF-8');
    to = checkEncoding(to || 'UTF-8');
    str = str || '';

    var result;

    if (from !== 'UTF-8' && typeof str === 'string') {
        str = new Buffer(str, 'binary');
  ***REMOVED***

    if (from === to) {
        if (typeof str === 'string') {
            result = new Buffer(str);
      ***REMOVED*** else {
            result = str;
      ***REMOVED***
  ***REMOVED*** else if (Iconv && !useLite) {
        try {
            result = convertIconv(str, to, from);
      ***REMOVED*** catch (E) {
            console.error(E);
            try {
                result = convertIconvLite(str, to, from);
          ***REMOVED*** catch (E) {
                console.error(E);
                result = str;
          ***REMOVED***
      ***REMOVED***
  ***REMOVED*** else {
        try {
            result = convertIconvLite(str, to, from);
      ***REMOVED*** catch (E) {
            console.error(E);
            result = str;
      ***REMOVED***
  ***REMOVED***


    if (typeof result === 'string') {
        result = new Buffer(result, 'utf-8');
  ***REMOVED***

    return result;
***REMOVED***

/**
 * Convert encoding of a string with node-iconv (if available)
 *
 * @param {String|Buffer***REMOVED*** str String to be converted
 * @param {String***REMOVED*** to Encoding to be converted to
 * @param {String***REMOVED*** [from='UTF-8'] Encoding to be converted from
 * @return {Buffer***REMOVED*** Encoded string
 */
function convertIconv(str, to, from) {
    var response, iconv;
    iconv = new Iconv(from, to + '//TRANSLIT//IGNORE');
    response = iconv.convert(str);
    return response.slice(0, response.length);
***REMOVED***

/**
 * Convert encoding of astring with iconv-lite
 *
 * @param {String|Buffer***REMOVED*** str String to be converted
 * @param {String***REMOVED*** to Encoding to be converted to
 * @param {String***REMOVED*** [from='UTF-8'] Encoding to be converted from
 * @return {Buffer***REMOVED*** Encoded string
 */
function convertIconvLite(str, to, from) {
    if (to === 'UTF-8') {
        return iconvLite.decode(str, from);
  ***REMOVED*** else if (from === 'UTF-8') {
        return iconvLite.encode(str, to);
  ***REMOVED*** else {
        return iconvLite.encode(iconvLite.decode(str, from), to);
  ***REMOVED***
***REMOVED***

/**
 * Converts charset name if needed
 *
 * @param {String***REMOVED*** name Character set
 * @return {String***REMOVED*** Character set name
 */
function checkEncoding(name) {
    return (name || '').toString().trim().
    replace(/^latin[\-_]?(\d+)$/i, 'ISO-8859-$1').
    replace(/^win(?:dows)?[\-_]?(\d+)$/i, 'WINDOWS-$1').
    replace(/^utf[\-_]?(\d+)$/i, 'UTF-$1').
    replace(/^ks_c_5601\-1987$/i, 'CP949').
    replace(/^us[\-_]?ascii$/i, 'ASCII').
    toUpperCase();
***REMOVED***
