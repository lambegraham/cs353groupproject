'use strict'

var assert = require('assert')
var stubs = require('./')
var tess = require('tess')

tess('init', function(it) {
  it('is a function', function() {
    assert.equal(typeof stubs, 'function')
***REMOVED***)

  it('throws without obj || method', function() {
    assert.throws(function() {
      stubs()
  ***REMOVED***, /must provide/)

    assert.throws(function() {
      stubs({***REMOVED***)
  ***REMOVED***, /must provide/)
***REMOVED***)
***REMOVED***)

tess('stubs', function(it) {
  it('stubs a method with a noop', function() {
    var originalCalled = false

    var obj = {***REMOVED***
    obj.method = function() {
      originalCalled = true
  ***REMOVED***

    stubs(obj, 'method')

    obj.method()

    assert(!originalCalled)
***REMOVED***)

  it('accepts an override', function() {
    var originalCalled = false

    var obj = {***REMOVED***
    obj.method = function() {
      originalCalled = true
  ***REMOVED***

    var replacementCalled = false
    stubs(obj, 'method', function() {
      replacementCalled = true
  ***REMOVED***)

    obj.method()
    assert(!originalCalled)
    assert(replacementCalled)
***REMOVED***)

  it('returns value of overridden method call', function() {
    var overriddenUniqueVal = {***REMOVED***

    var obj = {***REMOVED***
    obj.method = function() {***REMOVED***

    stubs(obj, 'method', { callthrough: true ***REMOVED***, function() {
      return overriddenUniqueVal
  ***REMOVED***)

    assert.strictEqual(obj.method(), overriddenUniqueVal)
***REMOVED***)

  it('calls through to original method', function() {
    var originalCalled = false

    var obj = {***REMOVED***
    obj.method = function() {
      originalCalled = true
  ***REMOVED***

    var replacementCalled = false
    stubs(obj, 'method', { callthrough: true ***REMOVED***, function() {
      replacementCalled = true
  ***REMOVED***)

    obj.method()
    assert(originalCalled)
    assert(replacementCalled)
***REMOVED***)

  it('returns value of original method call', function() {
    var uniqueVal = Date.now()

    var obj = {***REMOVED***
    obj.method = function() {
      return uniqueVal
  ***REMOVED***

    stubs(obj, 'method', { callthrough: true ***REMOVED***, function() {***REMOVED***)

    assert.equal(obj.method(), uniqueVal)
***REMOVED***)

  it('returns calls override and returns original value', function() {
    var uniqueVal = {***REMOVED***
    var overrideWasCalled = false

    var obj = {***REMOVED***
    obj.method = function() {
      return uniqueVal
  ***REMOVED***

    stubs(obj, 'method', { callthrough: true ***REMOVED***, function() {
      // does not return anything
      overrideWasCalled = true
  ***REMOVED***)

    assert.strictEqual(obj.method(), uniqueVal)
    assert.strictEqual(overrideWasCalled, true)
***REMOVED***)

  it('returns value of overridden method call', function() {
    var uniqueVal = {***REMOVED***
    var overriddenUniqueVal = {***REMOVED***

    var obj = {***REMOVED***
    obj.method = function() {
      return uniqueVal
  ***REMOVED***

    stubs(obj, 'method', { callthrough: true ***REMOVED***, function() {
      return overriddenUniqueVal
  ***REMOVED***)

    assert.strictEqual(obj.method(), overriddenUniqueVal)
***REMOVED***)

  it('stops calling stub after n calls', function() {
    var timesToCall = 5
    var timesCalled = 0

    var obj = {***REMOVED***
    obj.method = function() {
      assert.equal(timesCalled, timesToCall)
  ***REMOVED***

    stubs(obj, 'method', { calls: timesToCall ***REMOVED***, function() {
      timesCalled++
  ***REMOVED***)

    obj.method() // 1 (stub)
    obj.method() // 2 (stub)
    obj.method() // 3 (stub)
    obj.method() // 4 (stub)
    obj.method() // 5 (stub)
    obj.method() // 6 (original)
***REMOVED***)

  it('calls stub in original context of obj', function() {
    var secret = 'brownies'

    function Class() {
      this.method = function() {***REMOVED***
      this.secret = secret
  ***REMOVED***

    var cl = new Class()

    stubs(cl, 'method', function() {
      assert.equal(this.secret, secret)
  ***REMOVED***)

    cl.method()
***REMOVED***)
***REMOVED***)
