'use strict';
const execa = require('execa');
const lcid = require('lcid');
const mem = require('mem');

const defaultOptions = {spawn: true***REMOVED***;
const defaultLocale = 'en_US';

function getEnvLocale(env = process.env) {
	return env.LC_ALL || env.LC_MESSAGES || env.LANG || env.LANGUAGE;
***REMOVED***

function parseLocale(string) {
	const env = string.split('\n').reduce((env, def) => {
		const [key, value] = def.split('=');
		env[key] = value.replace(/^"|"$/g, '');
		return env;
	***REMOVED***, {***REMOVED***);

	return getEnvLocale(env);
***REMOVED***

function getLocale(string) {
	return (string && string.replace(/[.:].*/, ''));
***REMOVED***

function getLocales() {
	return execa.stdout('locale', ['-a']);
***REMOVED***

function getLocalesSync() {
	return execa.sync('locale', ['-a']).stdout;
***REMOVED***

function getSupportedLocale(locale, locales = '') {
	return locales.includes(locale) ? locale : defaultLocale;
***REMOVED***

function getAppleLocale() {
	return Promise.all([
		execa.stdout('defaults', ['read', '-globalDomain', 'AppleLocale']),
		getLocales()
	]).then(results => getSupportedLocale(results[0], results[1]));
***REMOVED***

function getAppleLocaleSync() {
	return getSupportedLocale(
		execa.sync('defaults', ['read', '-globalDomain', 'AppleLocale']).stdout,
		getLocalesSync()
	);
***REMOVED***

function getUnixLocale() {
	if (process.platform === 'darwin') {
		return getAppleLocale();
	***REMOVED***

	return execa.stdout('locale')
		.then(stdout => getLocale(parseLocale(stdout)));
***REMOVED***

function getUnixLocaleSync() {
	if (process.platform === 'darwin') {
		return getAppleLocaleSync();
	***REMOVED***

	return getLocale(parseLocale(execa.sync('locale').stdout));
***REMOVED***

function getWinLocale() {
	return execa.stdout('wmic', ['os', 'get', 'locale'])
		.then(stdout => {
			const lcidCode = parseInt(stdout.replace('Locale', ''), 16);
			return lcid.from(lcidCode);
		***REMOVED***);
***REMOVED***

function getWinLocaleSync() {
	const {stdout***REMOVED*** = execa.sync('wmic', ['os', 'get', 'locale']);
	const lcidCode = parseInt(stdout.replace('Locale', ''), 16);
	return lcid.from(lcidCode);
***REMOVED***

module.exports = mem((options = defaultOptions) => {
	const envLocale = getEnvLocale();

	let thenable;
	if (envLocale || options.spawn === false) {
		thenable = Promise.resolve(getLocale(envLocale));
	***REMOVED*** else if (process.platform === 'win32') {
		thenable = getWinLocale();
	***REMOVED*** else {
		thenable = getUnixLocale();
	***REMOVED***

	return thenable
		.then(locale => locale || defaultLocale)
		.catch(() => defaultLocale);
***REMOVED***);

module.exports.sync = mem((options = defaultOptions) => {
	const envLocale = getEnvLocale();

	let res;
	if (envLocale || options.spawn === false) {
		res = getLocale(envLocale);
	***REMOVED*** else {
		try {
			res = process.platform === 'win32' ? getWinLocaleSync() : getUnixLocaleSync();
		***REMOVED*** catch (_) {***REMOVED***
	***REMOVED***

	return res || defaultLocale;
***REMOVED***);
