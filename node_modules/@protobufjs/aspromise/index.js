"use strict";
module.exports = asPromise;

/**
 * Callback as used by {@link util.asPromise***REMOVED***.
 * @typedef asPromiseCallback
 * @type {function***REMOVED***
 * @param {Error|null***REMOVED*** error Error, if any
 * @param {...****REMOVED*** params Additional arguments
 * @returns {undefined***REMOVED***
 */

/**
 * Returns a promise from a node-style callback function.
 * @memberof util
 * @param {asPromiseCallback***REMOVED*** fn Function to call
 * @param {****REMOVED*** ctx Function context
 * @param {...****REMOVED*** params Function arguments
 * @returns {Promise<*>***REMOVED*** Promisified function
 */
function asPromise(fn, ctx/*, varargs */) {
    var params  = new Array(arguments.length - 1),
        offset  = 0,
        index   = 2,
        pending = true;
    while (index < arguments.length)
        params[offset++] = arguments[index++];
    return new Promise(function executor(resolve, reject) {
        params[offset] = function callback(err/*, varargs */) {
            if (pending) {
                pending = false;
                if (err)
                    reject(err);
                else {
                    var params = new Array(arguments.length - 1),
                        offset = 0;
                    while (offset < params.length)
                        params[offset++] = arguments[offset];
                    resolve.apply(null, params);
              ***REMOVED***
          ***REMOVED***
      ***REMOVED***
        try {
            fn.apply(ctx || null, params);
      ***REMOVED*** catch (err) {
            if (pending) {
                pending = false;
                reject(err);
          ***REMOVED***
      ***REMOVED***
  ***REMOVED***);
***REMOVED***
