var stream = require("readable-stream");

var bun = require("..");

var assert = require("assert");

describe("bun", function() {
  it("should be the best", function() {
    var bun = "is the best";

    assert.strictEqual(bun, "is the best");
***REMOVED***);

  it("should pass data through one stream", function(done) {
    var uppercaser = new stream.Transform({objectMode: true***REMOVED***);

    uppercaser._transform = function _transform(input, encoding, done) {
      this.push(input.toString().toUpperCase());
      return done();
  ***REMOVED***

    var stack = bun([uppercaser]);

    stack.on("readable", function() {
      var data = stack.read();

      assert(typeof data === "string", "data should be a string");
      assert(data === "HELLO", "data should be transformed correctly");

      done();
  ***REMOVED***);

    stack.write("hello");
***REMOVED***);

  it("should pass data through two streams", function(done) {
    var uppercaser  = new stream.Transform({objectMode: true***REMOVED***),
        underscorer = new stream.Transform({objectMode: true***REMOVED***);

    uppercaser._transform = function _transform(input, encoding, done) {
      this.push(input.toString().toUpperCase());
      return done();
  ***REMOVED***

    underscorer._transform = function _transform(input, encoding, done) {
      this.push(input.toString().split("").join("_"));
      return done();
  ***REMOVED***

    var stack = bun([uppercaser, underscorer]);

    stack.on("readable", function() {
      var data = stack.read();

      assert(typeof data === "string", "data should be a string");
      assert(data === "H_E_L_L_O", "data should be transformed correctly");

      done();
  ***REMOVED***);

    stack.write("hello");
***REMOVED***);

  it("should finish correctly with no streams and no data written", function(done) {
    var stack = bun([]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.end();
***REMOVED***);

  it("should finish correctly with one stream and no data written", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.end();
***REMOVED***);

  it("should finish correctly with two streams and no data written", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.end();
***REMOVED***);

  it("should finish correctly with no streams and some data written", function(done) {
    var stack = bun([]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.on("readable", function() {
      var e;
      while (e = stack.read()) {
    ***REMOVED***
  ***REMOVED***);

    stack.write("some data");
    stack.end();
***REMOVED***);

  it("should finish correctly with one stream and some data written", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.on("readable", function() {
      var e;
      while (e = stack.read()) {
    ***REMOVED***
  ***REMOVED***);

    stack.write("some data");
    stack.end();
***REMOVED***);

  it("should finish correctly with two streams and some data written", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    stack.on("readable", function() {
      var e;
      while (e = stack.read()) {
    ***REMOVED***
  ***REMOVED***);

    stack.write("some data");
    stack.end();
***REMOVED***);

  it("should finish correctly when piped through with no streams and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var stack = bun([]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.end();
***REMOVED***);

  it("should finish correctly when piped through with one stream and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.end();
***REMOVED***);

  it("should finish correctly when piped through with two streams and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.end();
***REMOVED***);

  it("should finish correctly when piped through with no streams and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var stack = bun([]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should finish correctly when piped through with one stream and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should finish correctly when piped through with two streams and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should end correctly when piped through with no streams and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var stack = bun([]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.push(null);
***REMOVED***);

  it("should end correctly when piped through with one stream and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.end();
***REMOVED***);

  it("should end correctly when piped through with two streams and no data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.end();
***REMOVED***);

  it("should end correctly when piped through with no streams and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var stack = bun([]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should end correctly when piped through with one stream and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should end correctly when piped through with two streams and some data written", function(done) {
    var input = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        bob   = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice, bob]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    input.pipe(stack).pipe(nowhere);
    input.write("hello");
    input.end();
***REMOVED***);

  it("should end wrapped streams correctly when ended", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***);

    alice.on("finish", function() {
      done();
  ***REMOVED***);

    var stack = bun([alice]);

    stack.end();
***REMOVED***);

  it("should finish when wrapped streams finish", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***),
        outside = new stream.PassThrough({objectMode: true***REMOVED***);

    var stack = bun([alice]);

    stack.on("finish", function() {
      done();
  ***REMOVED***);

    outside.pipe(stack).pipe(outside);

    alice.end();
***REMOVED***);

  it("should end when wrapped streams end", function(done) {
    var alice = new stream.PassThrough({objectMode: true***REMOVED***);
    var nowhere = new stream.Writable({objectMode: true***REMOVED***);
    nowhere._write = function _write(input, encoding, done) { return done(); ***REMOVED***;

    var stack = bun([alice]);

    stack.on("end", function() {
      done();
  ***REMOVED***);

    stack.pipe(nowhere);

    alice.push(null);
***REMOVED***);

  it("should forward errors if bubbleErrors is not specified", function(done) {
    var alice = new stream.PassThrough();

    var stack = bun([alice]);

    stack.on("error", function(err) {
      return done();
  ***REMOVED***);

    alice.emit("error", Error("test error"));
***REMOVED***);

  it("should forward errors if bubbleErrors is true", function(done) {
    var alice = new stream.PassThrough();

    var stack = bun([alice], {bubbleErrors: true***REMOVED***);

    stack.on("error", function(err) {
      return done();
  ***REMOVED***);

    alice.emit("error", Error("test error"));
***REMOVED***);

  it("should not forward errors if bubbleErrors is false", function(done) {
    var alice = new stream.PassThrough();

    var stack = bun([alice], {bubbleErrors: false***REMOVED***);

    var timeout = setTimeout(done, 10);

    stack.on("error", function(err) {
      clearTimeout(timeout);

      return done(Error("shouldn't have bubbled the error"));
  ***REMOVED***);

    alice.on("error", function(err) {
      // prevent uncaught error crash
  ***REMOVED***);

    alice.emit("error", Error("test error"));
***REMOVED***);
***REMOVED***);
